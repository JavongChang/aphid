#include "Calculus.h"

namespace aphid {

namespace calc {

void legendreRule(int m, int n, float * v,
		const float * xi)
{
	int i, j;

	for ( i = 0; i < m; i++ ) {
		v[i+0*m] = 1.0;
	}

	for ( i = 0; i < m; i++ ) {
		v[i+1*m] = xi[i];
	}
	
	for ( j = 2; j <= n; j++ ) {
		for ( i = 0; i < m; i++ ) {
			v[i+j*m] = ( ( float ) ( 2 * j - 1 ) *  (xi[i]) * v[i+(j-1)*m]   
					 - ( float ) (     j - 1 ) *        v[i+(j-2)*m] ) 
					 / ( float ) (     j     );
		}
	}
}

float interpolate(int nknots, const float * yknots, int m, float x, float a, float b, float dx)
{
	int g = (x - a) / dx;
	if(g<1)
		return yknots[0];
	if(g>=m-1)
		return yknots[nknots-1];
		
	float movern =  ((float)m - 1.0) / ((float)nknots - 1);
	int n0 = g / movern;
	int n1 = n0 + 1;
	
	float alpha = (g - n0 * movern) / movern;
	return yknots[n0] * (1.f - alpha) + yknots[n1] * alpha;
}

float trapezIntegral(const float & a, const float & b, int m, const float * y)
{
	const float h = (b - a) / (m - 1);
	float c = h * .5f * (y[0] + y[m-1]);
	int i=1;
	for(;i<m-1;++i) {
		c += h * y[i];
	}
	return c;
}

/// 2 + 3 + 4 + 5 + 6
static const float GaussQuadratureWeight[20] = {
1.f, 1.f,
.555555556f, .888888889f, .555555556f,
.347854845f, .652145155f, .652145155f, .347854845f,
.236926885f, .478628670f, .568888889f, .478628670f, .236926885f,
.171324492f, .360761573f, .467913935f, .467913935f, .360761573f, .171324492f
};

static const float GaussQuadratureArgument[20] = {
-.577350269f, .577350269f,
-.774596669f, 0.f, .774596669f,
-.861136312f, -.339981044f, .339981044f, .861136312f,
-.906179846f, -.538469310f, 0.f, .538469310f, .906179846f,
-.932469514f, -.661209386f, -.238619186f, .238619186f, .661209386f, .932469514f
};

static const int GaussQuadratureNInd[7] = {
0, 0, 0, 
2,
5,
9,
14
};

void gaussQuadratureRule(int n, float * ci, float * xi)
{
	const int i0 = GaussQuadratureNInd[n];
	for(int i=0; i<n; ++i) {
		ci[i] = GaussQuadratureWeight[i0 + i];
		xi[i] = GaussQuadratureArgument[i0 + i];
	}
}

void tuple_next( int m1, int m2, int n, int *rank, int x[] )
{
  int i;
  int j;

  if ( m2 < m1 )
  {
    *rank = 0;
    return;
  }

  if ( *rank <= 0 )
  {
    for ( i = 0; i < n; i++ )
    {
      x[i] = m1;
    }
    *rank = 1;
  }
  else
  {
    *rank = *rank + 1;
    i = n - 1;

    for ( ; ; )
    {

      if ( x[i] < m2 )
      {
        x[i] = x[i] + 1;
        break;
      }

      x[i] = m1;

      if ( i == 0 )
      {
        *rank = 0;
        for ( j = 0; j < n; j++ )
        {
          x[j] = m1;
        }
        break;
      }
      i = i - 1;
    }
  }

  return;
}

float gaussQuadratureRuleIntegrate(int n, int m, const float * xi, const float * wi, const float * Y)
{
	int k = 0, dim;
	float result = 0.f;
	int * indx = new int[n];
	float w;
	
	for ( ; ; ) {
		tuple_next ( 1, m, n, &k, indx );

		if ( k == 0  ) {
		  break;
		}

		w = 1.0;
		for ( dim = 0; dim < n; dim++ ) {
		  w = w * wi[indx[dim]-1];
		}

		result = result + w * Y[lexIndex(n, m, indx, -1)];
		
	}
	
	delete[] indx;
	return result;
	
}

int lexIndex(int n, int m, int * x, int offset)
{
	int result = 0;
	int mm = 1;
	int i=0;
	for(;i<n;++i) {
		result += (x[i] + offset) * mm;
		mm *= m;
	}
	return result;
}

const float LegendrePolynomial::mV[1799] = {
 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, 0.707107, -1.22474, -1.21518, -1.20561, -1.19604, -1.18647, -1.1769, -1.16733, -1.15777, -1.1482, -1.13863, -1.12906, -1.11949, -1.10993, -1.10036, -1.09079, -1.08122, -1.07165, -1.06208, -1.05252, -1.04295, -1.03338, -1.02381, -1.01424, -1.00467, -0.995105, -0.985537, -0.975969, -0.9664, -0.956832, -0.947264, -0.937695, -0.928127, -0.918559, -0.90899, -0.899422, -0.889854, -0.880285, -0.870717, -0.861149, -0.85158, -0.842012, -0.832444, -0.822875, -0.813307, -0.803739, -0.79417, -0.784602, -0.775034, -0.765465, -0.755897, -0.746329, -0.736761, -0.727192, -0.717624, -0.708056, -0.698487, -0.688919, -0.679351, -0.669782, -0.660214, -0.650646, -0.641077, -0.631509, -0.621941, -0.612372, -0.602804, -0.593236, -0.583667, -0.574099, -0.564531, -0.554963, -0.545394, -0.535826, -0.526258, -0.516689, -0.507121, -0.497553, -0.487984, -0.478416, -0.468848, -0.459279, -0.449711, -0.440143, -0.430574, -0.421006, -0.411438, -0.401869, -0.392301, -0.382733, -0.373164, -0.363596, -0.354028, -0.344459, -0.334891, -0.325323, -0.315755, -0.306186, -0.296618, -0.28705, -0.277481, -0.267913, -0.258345, -0.248776, -0.239208, -0.22964, -0.220071, -0.210503, -0.200935, -0.191366, -0.181798, -0.17223, -0.162661, -0.153093, -0.143525, -0.133956, -0.124388, -0.11482, -0.105252, -0.0956832, -0.0861149, -0.0765465, -0.0669782, -0.0574099, -0.0478416, -0.0382733, -0.028705, -0.0191366, -0.00956832, 0, 0.00956832, 0.0191366, 0.028705, 0.0382733, 0.0478416, 0.0574099, 0.0669782, 0.0765465, 0.0861149, 0.0956832, 0.105252, 0.11482, 0.124388, 0.133956, 0.143525, 0.153093, 0.162661, 0.17223, 0.181798, 0.191366, 0.200935, 0.210503, 0.220071, 0.22964, 0.239208, 0.248776, 0.258345, 0.267913, 0.277481, 0.28705, 0.296618, 0.306186, 0.315755, 0.325323, 0.334891, 0.344459, 0.354028, 0.363596, 0.373164, 0.382733, 0.392301, 0.401869, 0.411438, 0.421006, 0.430574, 0.440143, 0.449711, 0.459279, 0.468848, 0.478416, 0.487984, 0.497553, 0.507121, 0.516689, 0.526258, 0.535826, 0.545394, 0.554963, 0.564531, 0.574099, 0.583667, 0.593236, 0.602804, 0.612372, 0.621941, 0.631509, 0.641077, 0.650646, 0.660214, 0.669782, 0.679351, 0.688919, 0.698487, 0.708056, 0.717624, 0.727192, 0.736761, 0.746329, 0.755897, 0.765465, 0.775034, 0.784602, 0.79417, 0.803739, 0.813307, 0.822875, 0.832444, 0.842012, 0.85158, 0.861149, 0.870717, 0.880285, 0.889854, 0.899422, 0.90899, 0.918559, 0.928127, 0.937695, 0.947264, 0.956832, 0.9664, 0.975969, 0.985537, 0.995105, 1.00467, 1.01424, 1.02381, 1.03338, 1.04295, 1.05252, 1.06208, 1.07165, 1.08122, 1.09079, 1.10036, 1.10993, 1.11949, 1.12906, 1.13863, 1.1482, 1.15777, 1.16733, 1.1769, 1.18647, 1.19604, 1.20561, 1.21518, 1.22474, 1.58114, 1.54423, 1.5076, 1.47127, 1.43522, 1.39947, 1.364, 1.32883, 1.29394, 1.25934, 1.22504, 1.19102, 1.15729, 1.12385, 1.0907, 1.05784, 1.02527, 0.992989, 0.960997, 0.929295, 0.897883, 0.86676, 0.835927, 0.805383, 0.775129, 0.745164, 0.715488, 0.686103, 0.657006, 0.6282, 0.599682, 0.571455, 0.543516, 0.515868, 0.488509, 0.461439, 0.434659, 0.408168, 0.381967, 0.356055, 0.330433, 0.305101, 0.280058, 0.255304, 0.23084, 0.206666, 0.182781, 0.159185, 0.135879, 0.112863, 0.0901357, 0.0676983, 0.0455504, 0.023692, 0.00212311, -0.0191563, -0.0401461, -0.0608464, -0.0812573, -0.101379, -0.12121, -0.140753, -0.160005, -0.178969, -0.197642, -0.216027, -0.234121, -0.251926, -0.269442, -0.286668, -0.303605, -0.320252, -0.33661, -0.352678, -0.368456, -0.383945, -0.399145, -0.414055, -0.428675, -0.443006, -0.457048, -0.4708, -0.484262, -0.497435, -0.510319, -0.522913, -0.535217, -0.547232, -0.558957, -0.570393, -0.581539, -0.592396, -0.602964, -0.613241, -0.62323, -0.632928, -0.642338, -0.651457, -0.660288, -0.668828, -0.677079, -0.685041, -0.692713, -0.700096, -0.707189, -0.713993, -0.720507, -0.726731, -0.732666, -0.738312, -0.743668, -0.748734, -0.753511, -0.757999, -0.762197, -0.766105, -0.769724, -0.773054, -0.776094, -0.778844, -0.781305, -0.783476, -0.785358, -0.78695, -0.788253, -0.789267, -0.78999, -0.790425, -0.790569, -0.790425, -0.78999, -0.789267, -0.788253, -0.78695, -0.785358, -0.783476, -0.781305, -0.778844, -0.776094, -0.773054, -0.769724, -0.766105, -0.762197, -0.757999, -0.753511, -0.748734, -0.743668, -0.738312, -0.732666, -0.726731, -0.720507, -0.713993, -0.707189, -0.700096, -0.692713, -0.685041, -0.677079, -0.668828, -0.660288, -0.651457, -0.642338, -0.632928, -0.62323, -0.613241, -0.602964, -0.592396, -0.581539, -0.570393, -0.558957, -0.547232, -0.535217, -0.522913, -0.510319, -0.497435, -0.484262, -0.4708, -0.457048, -0.443006, -0.428675, -0.414055, -0.399145, -0.383945, -0.368456, -0.352678, -0.33661, -0.320252, -0.303605, -0.286668, -0.269442, -0.251926, -0.234121, -0.216027, -0.197642, -0.178969, -0.160005, -0.140753, -0.12121, -0.101379, -0.0812573, -0.0608464, -0.0401461, -0.0191563, 0.00212311, 0.023692, 0.0455504, 0.0676983, 0.0901357, 0.112863, 0.135879, 0.159185, 0.182781, 0.206666, 0.23084, 0.255304, 0.280058, 0.305101, 0.330433, 0.356055, 0.381967, 0.408168, 0.434659, 0.461439, 0.488509, 0.515868, 0.543516, 0.571455, 0.599682, 0.6282, 0.657006, 0.686103, 0.715488, 0.745164, 0.775129, 0.805383, 0.835927, 0.86676, 0.897883, 0.929295, 0.960997, 0.992989, 1.02527, 1.05784, 1.0907, 1.12385, 1.15729, 1.19102, 1.22504, 1.25934, 1.29394, 1.32883, 1.364, 1.39947, 1.43522, 1.47127, 1.5076, 1.54423, 1.58114, -1.87083, -1.78399, -1.69885, -1.61539, -1.53361, -1.45348, -1.37501, -1.29816, -1.22294, -1.14932, -1.07729, -1.00684, -0.937955, -0.870624, -0.804832, -0.740565, -0.67781, -0.616554, -0.556783, -0.498484, -0.441644, -0.386249, -0.332286, -0.279741, -0.228601, -0.178853, -0.130483, -0.0834778, -0.0378242, 0.00649122, 0.0494819, 0.0911613, 0.131543, 0.170639, 0.208465, 0.245033, 0.280356, 0.314448, 0.347323, 0.378993, 0.409472, 0.438774, 0.466911, 0.493898, 0.519748, 0.544473, 0.568088, 0.590605, 0.612039, 0.632402, 0.651708, 0.66997, 0.687202, 0.703417, 0.718628, 0.732849, 0.746093, 0.758374, 0.769705, 0.780099, 0.78957, 0.798131, 0.805795, 0.812576, 0.818488, 0.823543, 0.827754, 0.831137, 0.833703, 0.835466, 0.83644, 0.836637, 0.836072, 0.834758, 0.832707, 0.829934, 0.826452, 0.822274, 0.817414, 0.811884, 0.805699, 0.798871, 0.791415, 0.783343, 0.774669, 0.765406, 0.755567, 0.745167, 0.734218, 0.722734, 0.710728, 0.698213, 0.685204, 0.671712, 0.657752, 0.643338, 0.628482, 0.613197, 0.597498, 0.581397, 0.564908, 0.548045, 0.53082, 0.513247, 0.49534, 0.477112, 0.458576, 0.439745, 0.420634, 0.401255, 0.381621, 0.361747, 0.341645, 0.32133, 0.300813, 0.280109, 0.259232, 0.238193, 0.217008, 0.195688, 0.174248, 0.152701, 0.131061, 0.10934, 0.0875524, 0.0657111, 0.0438297, 0.0219215, -0, -0.0219215, -0.0438297, -0.0657111, -0.0875524, -0.10934, -0.131061, -0.152701, -0.174248, -0.195688, -0.217008, -0.238193, -0.259232, -0.280109, -0.300813, -0.32133, -0.341645, -0.361747, -0.381621, -0.401255, -0.420634, -0.439745, -0.458576, -0.477112, -0.49534, -0.513247, -0.53082, -0.548045, -0.564908, -0.581397, -0.597498, -0.613197, -0.628482, -0.643338, -0.657752, -0.671712, -0.685204, -0.698213, -0.710728, -0.722734, -0.734218, -0.745167, -0.755567, -0.765406, -0.774669, -0.783343, -0.791415, -0.798871, -0.805699, -0.811884, -0.817414, -0.822274, -0.826452, -0.829934, -0.832707, -0.834758, -0.836072, -0.836637, -0.83644, -0.835466, -0.833703, -0.831137, -0.827754, -0.823543, -0.818488, -0.812576, -0.805795, -0.798131, -0.78957, -0.780099, -0.769705, -0.758374, -0.746093, -0.732849, -0.718628, -0.703417, -0.687202, -0.66997, -0.651708, -0.632402, -0.612039, -0.590605, -0.568088, -0.544473, -0.519748, -0.493898, -0.466911, -0.438774, -0.409472, -0.378993, -0.347323, -0.314448, -0.280356, -0.245033, -0.208465, -0.170639, -0.131543, -0.0911613, -0.0494819, -0.00649122, 0.0378242, 0.0834778, 0.130483, 0.178853, 0.228601, 0.279741, 0.332286, 0.386249, 0.441644, 0.498484, 0.556783, 0.616554, 0.67781, 0.740565, 0.804832, 0.870624, 0.937955, 1.00684, 1.07729, 1.14932, 1.22294, 1.29816, 1.37501, 1.45348, 1.53361, 1.61539, 1.69885, 1.78399, 1.87083, 2.12132, 1.95849, 1.80138, 1.64988, 1.50389, 1.36332, 1.22805, 1.09798, 0.973018, 0.853058, 0.738002, 0.627752, 0.52221, 0.42128, 0.324866, 0.232873, 0.145206, 0.061773, -0.0175195, -0.092763, -0.164048, -0.231465, -0.295103, -0.355051, -0.411395, -0.464223, -0.51362, -0.559672, -0.602463, -0.642076, -0.678594, -0.712098, -0.742669, -0.770388, -0.795334, -0.817584, -0.837218, -0.85431, -0.868939, -0.881177, -0.8911, -0.898782, -0.904294, -0.907709, -0.909097, -0.908528, -0.906073, -0.901799, -0.895774, -0.888064, -0.878736, -0.867856, -0.855486, -0.841691, -0.826533, -0.810074, -0.792376, -0.773497, -0.753498, -0.732438, -0.710373, -0.68736, -0.663456, -0.638716, -0.613194, -0.586944, -0.560018, -0.532468, -0.504345, -0.4757, -0.446582, -0.417039, -0.387118, -0.356868, -0.326334, -0.295561, -0.264594, -0.233476, -0.202249, -0.170957, -0.139639, -0.108336, -0.0770882, -0.0459333, -0.0149091, 0.0159473, 0.0465997, 0.077013, 0.107153, 0.136985, 0.166478, 0.195599, 0.224316, 0.252601, 0.280422, 0.307753, 0.334564, 0.360829, 0.386521, 0.411616, 0.436089, 0.459916, 0.483075, 0.505543, 0.5273, 0.548324, 0.568597, 0.5881, 0.606814, 0.624724, 0.641812, 0.658064, 0.673465, 0.688001, 0.701659, 0.714428, 0.726295, 0.737252, 0.747288, 0.756394, 0.764563, 0.771787, 0.778061, 0.783378, 0.787735, 0.791128, 0.793554, 0.79501, 0.795495, 0.79501, 0.793554, 0.791128, 0.787735, 0.783378, 0.778061, 0.771787, 0.764563, 0.756394, 0.747288, 0.737252, 0.726295, 0.714428, 0.701659, 0.688001, 0.673465, 0.658064, 0.641812, 0.624724, 0.606814, 0.5881, 0.568597, 0.548324, 0.5273, 0.505543, 0.483075, 0.459916, 0.436089, 0.411616, 0.386521, 0.360829, 0.334564, 0.307753, 0.280422, 0.252601, 0.224316, 0.195599, 0.166478, 0.136985, 0.107153, 0.077013, 0.0465997, 0.0159473, -0.0149091, -0.0459333, -0.0770882, -0.108336, -0.139639, -0.170957, -0.202249, -0.233476, -0.264594, -0.295561, -0.326334, -0.356868, -0.387118, -0.417039, -0.446582, -0.4757, -0.504345, -0.532468, -0.560018, -0.586944, -0.613194, -0.638716, -0.663456, -0.68736, -0.710373, -0.732438, -0.753498, -0.773497, -0.792376, -0.810074, -0.826533, -0.841691, -0.855486, -0.867856, -0.878736, -0.888064, -0.895774, -0.901799, -0.906073, -0.908528, -0.909097, -0.907709, -0.904294, -0.898782, -0.8911, -0.881177, -0.868939, -0.85431, -0.837218, -0.817584, -0.795334, -0.770388, -0.742669, -0.712098, -0.678594, -0.642076, -0.602463, -0.559672, -0.51362, -0.464223, -0.411395, -0.355051, -0.295103, -0.231465, -0.164048, -0.092763, -0.0175195, 0.061773, 0.145206, 0.232873, 0.324866, 0.42128, 0.52221, 0.627752, 0.738002, 0.853058, 0.973018, 1.09798, 1.22805, 1.36332, 1.50389, 1.64988, 1.80138, 1.95849, 2.12132, -2.34521, -2.07782, -1.82499, -1.58627, -1.36121, -1.14936, -0.950302, -0.763599, -0.588838, -0.425609, -0.273509, -0.132146, -0.0011307, 0.119914, 0.23136, 0.333572, 0.426906, 0.511712, 0.588333, 0.657102, 0.718348, 0.772392, 0.819549, 0.860124, 0.894419, 0.922727, 0.945334, 0.962522, 0.974562, 0.981723, 0.984265, 0.982442, 0.976502, 0.966687, 0.953231, 0.936365, 0.916312, 0.893288, 0.867506, 0.83917, 0.808481, 0.775631, 0.74081, 0.7042, 0.665978, 0.626315, 0.585378, 0.543328, 0.500319, 0.456503, 0.412025, 0.367023, 0.321635, 0.275989, 0.23021, 0.184419, 0.138732, 0.0932592, 0.0481067, 0.00337626, -0.040835, -0.0844346, -0.127334, -0.16945, -0.210702, -0.251016, -0.290318, -0.328543, -0.365628, -0.401512, -0.43614, -0.469461, -0.501427, -0.531993, -0.561119, -0.588767, -0.614905, -0.639502, -0.66253, -0.683968, -0.703793, -0.72199, -0.738543, -0.753443, -0.76668, -0.77825, -0.788151, -0.796382, -0.802948, -0.807853, -0.811106, -0.812719, -0.812704, -0.811077, -0.807857, -0.803063, -0.796718, -0.788847, -0.779476, -0.768634, -0.756353, -0.742663, -0.7276, -0.7112, -0.6935, -0.674539, -0.65436, -0.633003, -0.610513, -0.586935, -0.562315, -0.536701, -0.510142, -0.482688, -0.45439, -0.425299, -0.395469, -0.364953, -0.333805, -0.302081, -0.269837, -0.237128, -0.204012, -0.170547, -0.136789, -0.102797, -0.068629, -0.0343438, 0, 0.0343438, 0.068629, 0.102797, 0.136789, 0.170547, 0.204012, 0.237128, 0.269837, 0.302081, 0.333805, 0.364953, 0.395469, 0.425299, 0.45439, 0.482688, 0.510142, 0.536701, 0.562315, 0.586935, 0.610513, 0.633003, 0.65436, 0.674539, 0.6935, 0.7112, 0.7276, 0.742663, 0.756353, 0.768634, 0.779476, 0.788847, 0.796718, 0.803063, 0.807857, 0.811077, 0.812704, 0.812719, 0.811106, 0.807853, 0.802948, 0.796382, 0.788151, 0.77825, 0.76668, 0.753443, 0.738543, 0.72199, 0.703793, 0.683968, 0.66253, 0.639502, 0.614905, 0.588767, 0.561119, 0.531993, 0.501427, 0.469461, 0.43614, 0.401512, 0.365628, 0.328543, 0.290318, 0.251016, 0.210702, 0.16945, 0.127334, 0.0844346, 0.040835, -0.00337626, -0.0481067, -0.0932592, -0.138732, -0.184419, -0.23021, -0.275989, -0.321635, -0.367023, -0.412025, -0.456503, -0.500319, -0.543328, -0.585378, -0.626315, -0.665978, -0.7042, -0.74081, -0.775631, -0.808481, -0.83917, -0.867506, -0.893288, -0.916312, -0.936365, -0.953231, -0.966687, -0.976502, -0.982442, -0.984265, -0.981723, -0.974562, -0.962522, -0.945334, -0.922727, -0.894419, -0.860124, -0.819549, -0.772392, -0.718348, -0.657102, -0.588333, -0.511712, -0.426906, -0.333572, -0.23136, -0.119914, 0.0011307, 0.132146, 0.273509, 0.425609, 0.588838, 0.763599, 0.950302, 1.14936, 1.36121, 1.58627, 1.82499, 2.07782, 2.34521, 2.54951, 2.14732, 1.7763, 1.43498, 1.12195, 0.835827, 0.57527, 0.338985, 0.125714, -0.0657587, -0.236611, -0.387982, -0.520973, -0.636651, -0.736045, -0.820147, -0.889918, -0.946283, -0.990133, -1.02233, -1.04369, -1.05503, -1.0571, -1.05063, -1.03635, -1.01491, -0.986974, -0.953161, -0.914065, -0.870255, -0.822273, -0.770639, -0.715844, -0.658358, -0.598629, -0.537078, -0.474108, -0.410099, -0.345409, -0.280376, -0.21532, -0.150539, -0.0863131, -0.0229044, 0.0394428, 0.100502, 0.160063, 0.217932, 0.273931, 0.327897, 0.379683, 0.429155, 0.476192, 0.520689, 0.562553, 0.601702, 0.638067, 0.67159, 0.702227, 0.72994, 0.754704, 0.776505, 0.795336, 0.8112, 0.824109, 0.834083, 0.841149, 0.845343, 0.846707, 0.84529, 0.841148, 0.834341, 0.824938, 0.81301, 0.798635, 0.781894, 0.762874, 0.741666, 0.718363, 0.693061, 0.665863, 0.63687, 0.606189, 0.573926, 0.540191, 0.505096, 0.468753, 0.431276, 0.392779, 0.353376, 0.313185, 0.272319, 0.230894, 0.189025, 0.146826, 0.104412, 0.0618938, 0.0193836, -0.0230087, -0.0651749, -0.107008, -0.148404, -0.18926, -0.229477, -0.268955, -0.3076, -0.34532, -0.382025, -0.417628, -0.452047, -0.485201, -0.517013, -0.547411, -0.576325, -0.603689, -0.629441, -0.653523, -0.675881, -0.696464, -0.715228, -0.732129, -0.747131, -0.760201, -0.771309, -0.780431, -0.787546, -0.79264, -0.795701, -0.796722, -0.795701, -0.79264, -0.787546, -0.780431, -0.771309, -0.760201, -0.747131, -0.732129, -0.715228, -0.696464, -0.675881, -0.653523, -0.629441, -0.603689, -0.576325, -0.547411, -0.517013, -0.485201, -0.452047, -0.417628, -0.382025, -0.34532, -0.3076, -0.268955, -0.229477, -0.18926, -0.148404, -0.107008, -0.0651749, -0.0230087, 0.0193836, 0.0618938, 0.104412, 0.146826, 0.189025, 0.230894, 0.272319, 0.313185, 0.353376, 0.392779, 0.431276, 0.468753, 0.505096, 0.540191, 0.573926, 0.606189, 0.63687, 0.665863, 0.693061, 0.718363, 0.741666, 0.762874, 0.781894, 0.798635, 0.81301, 0.824938, 0.834341, 0.841148, 0.84529, 0.846707, 0.845343, 0.841149, 0.834083, 0.824109, 0.8112, 0.795336, 0.776505, 0.754704, 0.72994, 0.702227, 0.67159, 0.638067, 0.601702, 0.562553, 0.520689, 0.476192, 0.429155, 0.379683, 0.327897, 0.273931, 0.217932, 0.160063, 0.100502, 0.0394428, -0.0229044, -0.0863131, -0.150539, -0.21532, -0.280376, -0.345409, -0.410099, -0.474108, -0.537078, -0.598629, -0.658358, -0.715844, -0.770639, -0.822273, -0.870255, -0.914065, -0.953161, -0.986974, -1.01491, -1.03635, -1.05063, -1.0571, -1.05503, -1.04369, -1.02233, -0.990133, -0.946283, -0.889918, -0.820147, -0.736045, -0.636651, -0.520973, -0.387982, -0.236611, -0.0657587, 0.125714, 0.338985, 0.57527, 0.835827, 1.12195, 1.43498, 1.7763, 2.14732, 2.54951
};

LegendrePolynomial::LegendrePolynomial() 
{}

void LegendrePolynomial::sample(int m, int n, float * v,
							float a, float b)
{
	const float dx = (b - a) / (m - 1);
  int i, j;

  for ( i = 0; i < m; i++ )
  {
    v[i+0*m] = 1.0;
  }
  
  for ( i = 0; i < m; i++ )
  {
    v[i+1*m] = (a + dx * i);
  }
 
  for ( j = 2; j <= n; j++ )
  {
	for ( i = 0; i < m; i++ )
    {
      v[i+j*m] = ( ( float ) ( 2 * j - 1 ) *  (a + dx * i) * v[i+(j-1)*m]   
                 - ( float ) (     j - 1 ) *        v[i+(j-2)*m] ) 
                 / ( float ) (     j     );
    }
  }
  
/// normalize
  float fnorm;
	for ( j = 0; j <= n; j++ ) {
		fnorm = norm(j);
		for ( i = 0; i < m; i++ ) {
			  v[i+j*m] /= fnorm;
		}
	}
}

float LegendrePolynomial::P(int l, const float & x)
{
	const float * vl = &mV[l*257];
	const float gx = (x + 1.f) / 2.f * 256;
/// out-of-bound
	if(gx < 0)	return vl[0];
	if(gx >= 256) return vl[256];
	
	const int g0 = gx;
	const int g1 = g0+1;
	const float alpha = gx - g0;
	if(alpha < 1e-3f) return vl[g0];
	
	return vl[g0] * (1.f - alpha) + vl[g1] * alpha; 

}

float LegendrePolynomial::norm(int i)
{ return sqrt ( 2.f / ( float ) ( 2 * i + 1 ) ); }

}

}
